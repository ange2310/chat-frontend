<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagn√≥stico Staff.php</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .code-block {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .suspect-line {
            background: #ff0000 !important;
            color: white !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">
    <div class="max-w-6xl mx-auto">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6">
            <h1 class="text-3xl font-bold mb-6">üîç Diagn√≥stico del Problema en Staff.php</h1>
            
            <div class="bg-red-900 border border-red-600 rounded-lg p-4 mb-6">
                <h3 class="text-red-300 font-semibold mb-2">üéØ OBJETIVO:</h3>
                <p class="text-red-100">Encontrar qu√© l√≠nea o archivo est√° causando la redirecci√≥n a "/dashboard/"</p>
            </div>

            <!-- Controles -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <button onclick="testStaffMinimal()" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700">
                    1. Test Staff M√≠nimo
                </button>
                <button onclick="checkAssets()" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">
                    2. Verificar Assets
                </button>
                <button onclick="testStaffDebug()" class="bg-purple-600 px-4 py-2 rounded hover:bg-purple-700">
                    3. Test Staff Debug
                </button>
                <button onclick="clearResults()" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-700">
                    Limpiar
                </button>
            </div>

            <!-- Resultados -->
            <div class="bg-gray-700 rounded-lg p-4 mb-6">
                <h3 class="font-semibold mb-3">üìã Resultados de Diagn√≥stico</h3>
                <div id="diagnosticResults" class="code-block min-h-[200px]">
                    Esperando diagn√≥stico...
                </div>
            </div>

            <!-- Plan de Acci√≥n -->
            <div class="bg-yellow-900 border border-yellow-600 rounded-lg p-4">
                <h3 class="text-yellow-300 font-semibold mb-2">üìã Plan de Diagn√≥stico:</h3>
                <ol class="text-yellow-100 space-y-2">
                    <li><strong>1. Staff M√≠nimo:</strong> Probar versi√≥n sin JavaScript para ver si el PHP causa el problema</li>
                    <li><strong>2. Verificar Assets:</strong> Revisar si auth-client.js o main.css tienen referencias a "dashboard"</li>
                    <li><strong>3. Staff Debug:</strong> Cargar scripts paso a paso para identificar el culpable</li>
                    <li><strong>4. An√°lisis:</strong> Interpretar resultados y dar soluci√≥n</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const container = document.getElementById('diagnosticResults');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                success: 'color: #10b981;',
                error: 'color: #ef4444;',
                warning: 'color: #f59e0b;',
                info: 'color: #3b82f6;',
                suspect: 'color: #ff0000; background: #ffff00; font-weight: bold;'
            };
            
            container.innerHTML += `<span style="${colors[type] || colors.info}">[${timestamp}] ${message}</span>\n`;
            container.scrollTop = container.scrollHeight;
        }

        function clearResults() {
            document.getElementById('diagnosticResults').innerHTML = 'Resultados limpiados...\n';
        }

        async function testStaffMinimal() {
            log('üß™ TEST 1: Probando staff-test.php (versi√≥n m√≠nima)...', 'info');
            
            try {
                // Intentar cargar la versi√≥n m√≠nima
                log('üì° Cargando staff-test.php...', 'info');
                
                const response = await fetch('/practicas/chat-frontend/public/staff-test.php');
                
                if (response.ok) {
                    const content = await response.text();
                    
                    if (content.includes('Staff Test Page')) {
                        log('‚úÖ staff-test.php se carga correctamente', 'success');
                        log('üí° CONCLUSI√ìN: El problema NO est√° en el PHP base', 'success');
                        log('üëâ El problema est√° en el JavaScript del staff.php original', 'warning');
                    } else {
                        log('‚ö†Ô∏è staff-test.php responde pero contenido inesperado', 'warning');
                    }
                } else {
                    log(`‚ùå staff-test.php fall√≥ con status: ${response.status}`, 'error');
                    
                    if (response.status === 302 || response.status === 301) {
                        const location = response.headers.get('Location');
                        log(`üö® REDIRECCI√ìN DETECTADA a: ${location}`, 'suspect');
                        
                        if (location && location.includes('dashboard')) {
                            log('üö® ¬°ENCONTRADO! staff-test.php redirije a dashboard', 'suspect');
                            log('üí° El problema est√° en protectStaffPage() o config PHP', 'suspect');
                        }
                    }
                }
                
            } catch (error) {
                log(`‚ùå Error en test m√≠nimo: ${error.message}`, 'error');
            }
        }

        async function checkAssets() {
            log('üß™ TEST 2: Verificando assets (CSS/JS)...', 'info');
            
            try {
                log('üì° Consultando check-assets.php...', 'info');
                
                const response = await fetch('/practicas/chat-frontend/public/check-assets.php');
                const data = await response.json();
                
                log('‚úÖ Datos de assets recibidos', 'success');
                
                // Verificar CSS
                if (data.assets.CSS) {
                    data.assets.CSS.forEach(css => {
                        if (css.exists) {
                            log(`‚úÖ CSS encontrado: ${css.path}`, 'success');
                            if (css.has_dashboard_reference) {
                                log(`üö® CSS contiene 'dashboard': ${css.path}`, 'suspect');
                                css.dashboard_lines.forEach(line => {
                                    log(`   L√≠nea ${line.line}: ${line.content}`, 'suspect');
                                });
                            }
                        } else {
                            log(`‚ùå CSS no encontrado: ${css.path}`, 'error');
                        }
                    });
                }
                
                // Verificar JS
                if (data.assets.JS) {
                    data.assets.JS.forEach(js => {
                        if (js.exists) {
                            log(`‚úÖ JS encontrado: ${js.path}`, 'success');
                            if (js.has_dashboard_reference) {
                                log(`üö® JS contiene 'dashboard': ${js.path}`, 'suspect');
                                js.dashboard_lines.forEach(line => {
                                    log(`   L√≠nea ${line.line}: ${line.content}`, 'suspect');
                                });
                            }
                        } else {
                            log(`‚ö†Ô∏è JS no encontrado: ${js.path}`, 'warning');
                        }
                    });
                }
                
                // Verificar archivos de configuraci√≥n
                if (data.config_files) {
                    data.config_files.forEach(config => {
                        if (config.exists) {
                            log(`‚úÖ Config encontrado: ${config.path}`, 'success');
                            if (config.has_dashboard_reference) {
                                log(`üö® Config contiene 'dashboard': ${config.path}`, 'suspect');
                                log(`   Contenido: ${config.content.substring(0, 200)}...`, 'suspect');
                            }
                        }
                    });
                }
                
            } catch (error) {
                log(`‚ùå Error verificando assets: ${error.message}`, 'error');
            }
        }

        async function testStaffDebug() {
            log('üß™ TEST 3: Probando staff-debug.php (carga controlada)...', 'info');
            
            try {
                log('üì° Abriendo staff-debug.php en nueva ventana...', 'info');
                log('üëÄ Observa la consola de la nueva ventana para ver qu√© pasa', 'warning');
                
                // Abrir en nueva ventana para poder monitorear
                const newWindow = window.open('/practicas/chat-frontend/public/staff-debug.php', '_blank');
                
                if (newWindow) {
                    log('‚úÖ staff-debug.php abierto en nueva ventana', 'success');
                    log('üëâ Usa los botones de esa p√°gina para cargar scripts paso a paso', 'info');
                    
                    // Monitorear si se cierra inmediatamente (indicativo de redirecci√≥n)
                    setTimeout(() => {
                        if (newWindow.closed) {
                            log('‚ö†Ô∏è La ventana se cerr√≥ inmediatamente - posible redirecci√≥n', 'warning');
                        } else {
                            log('‚úÖ La ventana permanece abierta - buen signo', 'success');
                        }
                    }, 2000);
                } else {
                    log('‚ùå No se pudo abrir staff-debug.php', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error en test debug: ${error.message}`, 'error');
            }
        }

        // Funci√≥n helper para hacer requests y detectar redirecciones
        async function detectRedirect(url) {
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    redirect: 'manual' // No seguir redirecciones autom√°ticamente
                });
                
                if (response.type === 'opaqueredirect' || 
                    response.status >= 300 && response.status < 400) {
                    
                    const location = response.headers.get('Location') || 'unknown';
                    return {
                        isRedirect: true,
                        status: response.status,
                        location: location
                    };
                }
                
                return {
                    isRedirect: false,
                    status: response.status
                };
                
            } catch (error) {
                return {
                    isRedirect: false,
                    error: error.message
                };
            }
        }

        // Auto-start algunos tests b√°sicos
        document.addEventListener('DOMContentLoaded', () => {
            log('üü¢ Diagn√≥stico iniciado', 'success');
            log('üìç URL actual: ' + window.location.href, 'info');
            log('üëÜ Usa los botones para ejecutar tests paso a paso', 'info');
            
            // Auto-test b√°sico despu√©s de 2 segundos
            setTimeout(() => {
                log('ü§ñ Iniciando auto-test b√°sico...', 'info');
                checkAssets();
            }, 2000);
        });
    </script>
</body>
</html>